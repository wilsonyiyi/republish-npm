name: Publish to NPM

on:
  push:
    tags:
      - 'v*' # åŒ¹é… v å¼€å¤´çš„ tagï¼Œå¦‚ v1.0.0, v0.1.0

jobs:
  publish:
    name: å‘å¸ƒåˆ° npm
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # ç”¨äºåˆ›å»º GitHub Release
      id-token: write # ç”¨äº npm provenance

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4

      - name: è·å– pnpm store ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ç¼“å­˜ pnpm ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: éªŒè¯ tag ä¸ package.json ç‰ˆæœ¬ä¸€è‡´
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "Tag version: $TAG_VERSION"
          echo "Package version: $PKG_VERSION"
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "é”™è¯¯ï¼štag ç‰ˆæœ¬ ($TAG_VERSION) ä¸ package.json ç‰ˆæœ¬ ($PKG_VERSION) ä¸ä¸€è‡´ï¼"
            exit 1
          fi
          echo "âœ“ ç‰ˆæœ¬éªŒè¯é€šè¿‡"

      - name: æ„å»ºï¼ˆå¦‚æœéœ€è¦ï¼‰
        run: |
          # å½“å‰é¡¹ç›®ä¸éœ€è¦æ„å»ºæ­¥éª¤
          echo "âœ“ è·³è¿‡æ„å»ºæ­¥éª¤"

      - name: å‘å¸ƒåˆ° npm
        run: pnpm publish --no-git-checks --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## ğŸ“¦ ç‰ˆæœ¬å‘å¸ƒ

            å·²è‡ªåŠ¨å‘å¸ƒåˆ° npm: [@wilson_janet/republish-npm](https://www.npmjs.com/package/@wilson_janet/republish-npm)

            ### å®‰è£…
            ```bash
            npm install -g @wilson_janet/republish-npm
            # æˆ–
            pnpm add -g @wilson_janet/republish-npm
            ```

            ### æ›´æ–°å†…å®¹

            æŸ¥çœ‹ [CHANGELOG.md](https://github.com/wilsonyiyi/republish-npm/blob/master/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          draft: false
          prerelease: false
          generate_release_notes: true

