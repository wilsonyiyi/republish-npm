# é¡¹ç›®æ¶æ„è¯´æ˜

## ğŸ“¦ é¡¹ç›®æ¦‚è¿°

`republish-npm` æ˜¯ä¸€ä¸ª Node.js CLI å·¥å…·ï¼Œç”¨äºå°† npm åŒ…çš„å†å²ç‰ˆæœ¬æ‰¹é‡æ”¹åå¹¶é‡æ–°å‘å¸ƒåˆ°æ–°åŒ…åä¸‹ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
republish-npm/
â”œâ”€â”€ cli.js                  # CLI å…¥å£æ–‡ä»¶ï¼ˆbinï¼‰
â”œâ”€â”€ src/                    # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ index.js           # ä¸»ç¨‹åºé€»è¾‘
â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ args.js        # å‘½ä»¤è¡Œå‚æ•°è§£æ
â”‚   â”‚   â”œâ”€â”€ confirm.js     # ç”¨æˆ·äº¤äº’ç¡®è®¤
â”‚   â”‚   â”œâ”€â”€ npm.js         # npm ç›¸å…³æ“ä½œ
â”‚   â”‚   â”œâ”€â”€ package.js     # package.json å¤„ç†
â”‚   â”‚   â””â”€â”€ version.js     # ç‰ˆæœ¬è¿‡æ»¤é€»è¾‘
â”‚   â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ logger.js      # æ—¥å¿—è¾“å‡º
â”‚       â”œâ”€â”€ loader.js      # Loading åŠ¨ç”»
â”‚       â””â”€â”€ runner.js      # å‘½ä»¤æ‰§è¡Œ
â”œâ”€â”€ package.json           # é¡¹ç›®é…ç½®
â”œâ”€â”€ README.md              # ç”¨æˆ·æ–‡æ¡£
â”œâ”€â”€ PUBLISH.md             # å‘å¸ƒæŒ‡å—
â”œâ”€â”€ ARCHITECTURE.md        # æ¶æ„è¯´æ˜ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”œâ”€â”€ LICENSE                # MIT è®¸å¯è¯
â”œâ”€â”€ .npmignore             # npm å‘å¸ƒå¿½ç•¥é…ç½®
â””â”€â”€ .gitignore             # git å¿½ç•¥é…ç½®
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CLI Entry (cli.js)          â”‚  â† å‘½ä»¤è¡Œå…¥å£
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Main Process (src/index.js)    â”‚  â† ä¸»æµç¨‹æ§åˆ¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Core Layer  â”‚  â”‚ Utils Layer  â”‚
â”‚  (src/core/) â”‚  â”‚ (src/utils/) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—èŒè´£

#### 1. CLI å±‚ (cli.js)

- **èŒè´£**ï¼šä½œä¸ºå¯æ‰§è¡Œæ–‡ä»¶å…¥å£
- **åŠŸèƒ½**ï¼š
  - è®¾ç½® shebang (`#!/usr/bin/env node`)
  - å¼•å…¥å¹¶æ‰§è¡Œä¸»ç¨‹åº

#### 2. ä¸»ç¨‹åºå±‚ (src/index.js)

- **èŒè´£**ï¼šåè°ƒæ‰€æœ‰æ¨¡å—ï¼Œæ§åˆ¶æ•´ä½“æµç¨‹
- **åŠŸèƒ½**ï¼š
  - è§£æå‚æ•°
  - æ˜¾ç¤ºé…ç½®ä¿¡æ¯
  - è®¤è¯æ£€æŸ¥
  - ç”¨æˆ·ç¡®è®¤
  - åˆ›å»ºä¸´æ—¶ç›®å½•
  - ç‰ˆæœ¬ç­›é€‰
  - æ‰¹é‡å¤„ç†åŒ…
  - é”™è¯¯å¤„ç†å’Œç»Ÿè®¡

#### 3. æ ¸å¿ƒåŠŸèƒ½å±‚ (src/core/)

**args.js - å‚æ•°è§£æ**

- è§£æå‘½ä»¤è¡Œå‚æ•°
- éªŒè¯å‚æ•°åˆæ³•æ€§
- æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

**confirm.js - ç”¨æˆ·ç¡®è®¤**

- äº¤äº’å¼ç¡®è®¤æç¤º
- å¤„ç† `--yes` å’Œ `--dry-run`
- é”™è¯¯å¤„ç†

**npm.js - npm æ“ä½œ**

- è®¤è¯æ£€æŸ¥ (`npm whoami`)
- è·å–ç‰ˆæœ¬åˆ—è¡¨ (`npm view`)
- ä¸‹è½½åŒ… (`npm pack`)
- å‘å¸ƒåŒ… (`npm publish`)
- è§£å‹ tgz æ–‡ä»¶

**package.js - package.json å¤„ç†**

- è¯»å†™ JSON æ–‡ä»¶
- ä¿®æ”¹åŒ…å
- æ¸…ç†æ„å»ºè„šæœ¬
- ç§»é™¤å†²çªé…ç½®

**version.js - ç‰ˆæœ¬è¿‡æ»¤**

- ç‰ˆæœ¬åŒ…å«ç­›é€‰
- ç‰ˆæœ¬æ’é™¤ç­›é€‰
- æ”¯æŒç»„åˆç­›é€‰

#### 4. å·¥å…·å±‚ (src/utils/)

**logger.js - æ—¥å¿—å·¥å…·**

- ç»Ÿä¸€çš„æ—¥å¿—è¾“å‡ºæ¥å£
- æ”¯æŒæ™®é€šã€è­¦å‘Šã€é”™è¯¯ä¸‰ç§çº§åˆ«

**loader.js - Loading åŠ¨ç”»**

- Spinner åŠ¨ç”»æ•ˆæœ
- æˆåŠŸ/å¤±è´¥çŠ¶æ€åˆ‡æ¢
- æå‡ç”¨æˆ·ä½“éªŒ

**runner.js - å‘½ä»¤æ‰§è¡Œ**

- å°è£… `child_process.spawnSync`
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- è¿”å›æ ‡å‡†è¾“å‡º

## ğŸ”„ æ•°æ®æµ

```
1. ç”¨æˆ·è¾“å…¥å‘½ä»¤
   â†“
2. parseArgs() è§£æå‚æ•°
   â†“
3. ensureNpmAuth() æ£€æŸ¥è®¤è¯
   â†“
4. confirmOrExit() ç”¨æˆ·ç¡®è®¤
   â†“
5. getAllVersions() è·å–ç‰ˆæœ¬åˆ—è¡¨
   â†“
6. filterVersions() è¿‡æ»¤ç‰ˆæœ¬
   â†“
7. å¾ªç¯å¤„ç†æ¯ä¸ªç‰ˆæœ¬ï¼š
   â”œâ”€ packOneVersion()      ä¸‹è½½åŒ…
   â”œâ”€ extractToReadyDir()   è§£å‹
   â”œâ”€ rewriteName()         ä¿®æ”¹åŒ…å
   â””â”€ publishOne()          å‘å¸ƒ
   â†“
8. ç»Ÿè®¡å¹¶è¾“å‡ºç»“æœ
```

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™

æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤ã€‚

### 2. æ¨¡å—åŒ–è®¾è®¡

- **é«˜å†…èš**ï¼šç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨åŒä¸€æ¨¡å—
- **ä½è€¦åˆ**ï¼šæ¨¡å—é—´é€šè¿‡æ˜ç¡®çš„æ¥å£é€šä¿¡
- **å¯æµ‹è¯•**ï¼šæ¯ä¸ªæ¨¡å—éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•

### 3. å‘åå…¼å®¹

- ä½¿ç”¨ CommonJS æ¨¡å—ç³»ç»Ÿ
- æ”¯æŒ Node.js >= 14.17.0
- ä¸ä½¿ç”¨å®éªŒæ€§ API

### 4. ç”¨æˆ·ä½“éªŒä¼˜å…ˆ

- æ¸…æ™°çš„è¿›åº¦æç¤º
- Loading åŠ¨ç”»åé¦ˆ
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- å‹å¥½çš„äº¤äº’ç¡®è®¤

## ğŸ”Œ æ‰©å±•æ€§

### æ·»åŠ æ–°åŠŸèƒ½çš„æ­¥éª¤

1. **ç¡®å®šåŠŸèƒ½ç±»å‹**

   - å·¥å…·ç±» â†’ `src/utils/`
   - æ ¸å¿ƒä¸šåŠ¡ â†’ `src/core/`

2. **åˆ›å»ºæ–°æ¨¡å—æ–‡ä»¶**

   ```javascript
   // src/core/new-feature.js
   function newFeature() {
     // å®ç°åŠŸèƒ½
   }

   module.exports = { newFeature };
   ```

3. **åœ¨ä¸»ç¨‹åºä¸­å¼•å…¥**

   ```javascript
   // src/index.js
   const { newFeature } = require("./core/new-feature");
   ```

4. **æ›´æ–°æ–‡æ¡£**
   - æ›´æ–° `src/README.md`
   - æ›´æ–°æœ¬æ–‡æ¡£
   - æ›´æ–°ç”¨æˆ· `README.md`

### æµ‹è¯•å»ºè®®

```
tests/
â”œâ”€â”€ unit/              # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ core/
â”‚   â””â”€â”€ utils/
â”œâ”€â”€ integration/       # é›†æˆæµ‹è¯•
â””â”€â”€ e2e/              # ç«¯åˆ°ç«¯æµ‹è¯•
```

## ğŸ“Š ä¾èµ–å…³ç³»å›¾

```
index.js
â”œâ”€â”€ core/args.js
â”‚   â””â”€â”€ utils/logger.js
â”œâ”€â”€ core/confirm.js
â”‚   â””â”€â”€ utils/logger.js
â”œâ”€â”€ core/version.js
â”œâ”€â”€ core/package.js
â”‚   â””â”€â”€ utils/logger.js
â””â”€â”€ core/npm.js
    â”œâ”€â”€ utils/logger.js
    â”œâ”€â”€ utils/loader.js
    â””â”€â”€ utils/runner.js
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **è¾“å…¥éªŒè¯**

   - å‚æ•°åˆæ³•æ€§æ£€æŸ¥
   - ç‰ˆæœ¬å·æ ¼å¼éªŒè¯

2. **ä¸´æ—¶æ–‡ä»¶ç®¡ç†**

   - ä½¿ç”¨ç³»ç»Ÿä¸´æ—¶ç›®å½•
   - è‡ªåŠ¨æ¸…ç†ï¼ˆç”±æ“ä½œç³»ç»Ÿè´Ÿè´£ï¼‰

3. **é”™è¯¯å¤„ç†**
   - ç½‘ç»œé”™è¯¯è¯†åˆ«
   - åŠæ—¶ç»ˆæ­¢å¼‚å¸¸æµç¨‹
   - é˜²æ­¢æ•°æ®æŸå

## ğŸ“ ä»£ç è§„èŒƒ

- **å‘½åè§„èŒƒ**ï¼šé©¼å³°å¼å‘½åï¼ˆcamelCaseï¼‰
- **ç¼©è¿›**ï¼š2 ç©ºæ ¼
- **æ³¨é‡Š**ï¼šå‡½æ•°å’Œå¤æ‚é€»è¾‘éœ€è¦æ³¨é‡Š
- **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨ try-catch æˆ–é”™è¯¯å›è°ƒ
- **æ—¥å¿—è¾“å‡º**ï¼šä½¿ç”¨ç»Ÿä¸€çš„ logger æ¨¡å—

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

- **åŒæ­¥æ“ä½œ**ï¼šä½¿ç”¨åŒæ­¥ APIï¼Œç®€åŒ–æµç¨‹
- **ä¸´æ—¶ç›®å½•**ï¼šä½¿ç”¨ç³»ç»Ÿä¸´æ—¶ç›®å½•ï¼Œè‡ªåŠ¨æ¸…ç†
- **é”™è¯¯å¿«é€Ÿå¤±è´¥**ï¼šç½‘ç»œé”™è¯¯æ—¶æå‰ç»ˆæ­¢

## ğŸ“š å‚è€ƒèµ„æº

- [Node.js å®˜æ–¹æ–‡æ¡£](https://nodejs.org/docs/)
- [npm CLI æ–‡æ¡£](https://docs.npmjs.com/cli/)
- [minimist å‚æ•°è§£æ](https://github.com/minimistjs/minimist)
- [tar æ¨¡å—](https://github.com/npm/node-tar)
